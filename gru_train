# gru_train.py
import numpy as np
import pandas as pd
import tensorflow as tf  # type: ignore
from tensorflow.keras.models import Sequential  # type: ignore
from tensorflow.keras.layers import GRU, Dense, Dropout  # type: ignore
from tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint  # type: ignore
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
import matplotlib.pyplot as plt

# Charger les sequences
X_train = np.load("X_train_seq.npy")
y_train = np.load("y_train_seq.npy")
X_test = np.load("X_test_seq.npy")
y_test = np.load("y_test_seq.npy")

# Paramètres
n_timesteps = X_train.shape[1]
n_features  = X_train.shape[2]
batch_size = 32
epochs = 100

# Architecture GRU SIMPLE et ROBUSTE
model = Sequential()
model.add(GRU(64, return_sequences=True, input_shape=(n_timesteps, n_features)))
model.add(Dropout(0.2))

model.add(GRU(32, return_sequences=False))
model.add(Dropout(0.2))

model.add(Dense(16, activation='relu'))
model.add(Dense(1, activation='linear'))

model.compile(optimizer=tf.keras.optimizers.Adam(learning_rate=1e-3), loss='mse', metrics=['mae'])

model.summary()

# Callbacks
es = EarlyStopping(monitor='val_loss', patience=10, restore_best_weights=True)
mc = ModelCheckpoint('gru_tte_best.h5', monitor='val_loss', save_best_only=True)

history = model.fit(
    X_train, y_train,
    validation_split=0.1,
    epochs=epochs,
    batch_size=batch_size,
    callbacks=[es, mc],
    verbose=2
)

# Evaluate
preds = model.predict(X_test).flatten()
mse = mean_squared_error(y_test, preds)
rmse = np.sqrt(mse)
mae = mean_absolute_error(y_test, preds)
r2 = r2_score(y_test, preds)

print(f"GRU — RMSE: {rmse:.6f}, MAE: {mae:.6f}, R2: {r2:.6f}")

# Save final model
model.save("gru_tte_final.h5")

# Plot training history
plt.figure(figsize=(10,4))
plt.plot(history.history['loss'], label='train loss')
plt.plot(history.history['val_loss'], label='val loss')
plt.legend()
plt.title("Training loss")
plt.show()

# Plot predictions (first N points)
N = min(500, len(y_test))
plt.figure(figsize=(12,5))
plt.plot(y_test[:N], label='Actual')
plt.plot(preds[:N], label='GRU preds')
plt.legend()
plt.show()

# Save preds + true for later comparison
pd.DataFrame({'y_true': y_test, 'y_pred_gru': preds}).to_csv("gru_preds.csv", index=False)
